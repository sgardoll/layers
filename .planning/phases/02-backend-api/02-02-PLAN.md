# Plan 02-02: Flutter API Client + Job Polling

## Goal
Integrate the Flutter app with the backend API to submit images, poll for job completion, and display layer results.

## Dependencies
- 02-01 (Backend service must be running)

## Tasks

### 1. Layer Service
- [ ] Create `lib/services/layer_service.dart`
- [ ] Implement `submitJob(File image)` → uploads image, returns Job
- [ ] Implement `getJobStatus(String jobId)` → returns Job with status
- [ ] Implement `pollUntilComplete(String jobId)` → Stream<Job> with updates
- [ ] Handle all error cases (network, timeout, API errors)

### 2. Job State Management
- [ ] Create `lib/providers/job_provider.dart` using Riverpod
- [ ] `currentJobProvider` - StateNotifier for active job
- [ ] `jobHistoryProvider` - List of recent jobs (for retry)
- [ ] Auto-poll when job is pending/processing
- [ ] Stop polling on completion/failure/cancel

### 3. Image Import Flow
- [ ] Update `lib/screens/project_screen.dart` with import button
- [ ] Use image_picker for camera roll selection
- [ ] Show upload progress indicator
- [ ] Transition to processing state after upload

### 4. Processing UI States
- [ ] Create `lib/widgets/processing_indicator.dart`
- [ ] States: uploading → processing → packaging → ready
- [ ] Show estimated time remaining (based on fal.ai ~20s average)
- [ ] Cancel button to abort job
- [ ] Error state with retry button

### 5. Layer Results Integration
- [ ] On job completion, parse layers into Layer models
- [ ] Create Project from layers
- [ ] Navigate to LayersScreen with loaded project
- [ ] Cache layer images locally for offline viewing

### 6. Error Handling & Retry
- [ ] Network error → show retry with exponential backoff
- [ ] API error → show message + retry button
- [ ] Timeout (>60s) → show "taking longer than expected" + continue waiting
- [ ] Job failed → show error reason + "try different image" suggestion

## Provider Structure

```dart
// Job submission and polling
final layerServiceProvider = Provider<LayerService>((ref) => ...);

// Current active job state
final currentJobProvider = StateNotifierProvider<CurrentJobNotifier, AsyncValue<Job?>>((ref) => ...);

// Job status enum for UI
enum JobUIState { idle, uploading, processing, packaging, ready, failed }
final jobUIStateProvider = Provider<JobUIState>((ref) => ...);
```

## Screen Flow

```
ProjectScreen (empty) 
  → tap "Import Image" 
  → image_picker 
  → uploading overlay 
  → processing overlay (with progress) 
  → LayersScreen (with layers loaded)
```

## Verification
- [ ] Can select image from camera roll
- [ ] Upload shows progress indicator
- [ ] Processing state polls and updates UI
- [ ] Completion navigates to layers view
- [ ] Layers display correctly with transparency
- [ ] Cancel aborts the job
- [ ] Retry works after failure
- [ ] Works offline with cached layers

## Files to Create/Modify
- `lib/services/layer_service.dart` (new)
- `lib/providers/job_provider.dart` (new)
- `lib/widgets/processing_indicator.dart` (new)
- `lib/screens/project_screen.dart` (modify - add import flow)
- `lib/models/job.dart` (new - client-side job model)
