# Plan 02.1-02: BuildShip Workflows

## Objective
Create BuildShip workflows triggered by Supabase database events.

## Workflows

### Workflow A: Run Layering Job
**Trigger:** Supabase webhook on `projects` INSERT

**Input payload:**
```json
{
  "type": "INSERT",
  "table": "projects", 
  "schema": "public",
  "record": { /* inserted row */ }
}
```

**Steps:**
1. **Guard**: If `record.status !== 'queued'`, exit early
2. **Update status**: `UPDATE projects SET status='processing' WHERE id=?`
3. **Fetch image**: Download from `source_image_path` (Supabase Storage signed URL)
4. **Call AI model**: `qwen-lm/qwen-image-layered` with image + params
5. **Upload outputs**:
   - Upload `manifest.json` to `manifests/{project_id}/manifest.json`
   - Upload each layer PNG to `layers/{project_id}/layer_{i}.png`
6. **Insert layers**: For each layer, INSERT into `project_layers`
7. **Update project**: 
   - Success: `status='ready', manifest_path='...'`
   - Failure: `status='failed', error_message='...'`

### Workflow B: Cleanup Project Assets
**Trigger:** Supabase webhook on `projects` DELETE

**Input payload:**
```json
{
  "type": "DELETE",
  "table": "projects",
  "schema": "public", 
  "old_record": { /* deleted row */ }
}
```

**Steps:**
1. **Get project_id** from `old_record.id`
2. **List storage files** in `layers/{project_id}/`
3. **Delete layer files** from storage
4. **Delete manifest** from `manifests/{project_id}/`
5. **Delete exports**: Query `exports` for project_id, delete their `asset_path` files
6. **Rows auto-deleted** via CASCADE

### Workflow C: Build Export
**Trigger:** Supabase webhook on `exports` INSERT

**Input payload:**
```json
{
  "type": "INSERT",
  "table": "exports",
  "schema": "public",
  "record": { /* inserted row */ }
}
```

**Steps:**
1. **Guard**: If `record.status !== 'queued'`, exit
2. **Update status**: `processing`
3. **Fetch layers**: 
   - If `options.layerIds` specified, fetch those
   - Else fetch all layers for `project_id`
4. **Build export by type**:
   - `pngs`: Generate signed URLs for each layer, store in `asset_url` as JSON array
   - `zip`: Create ZIP of selected layer PNGs, upload to `exports/{export_id}.zip`
   - `layersPack`: Create ZIP with source.png + manifest.json + layers/*.png
5. **Update export**: `status='ready', asset_path='...', asset_url='...'`

### Workflow D: Cleanup Export (optional)
**Trigger:** Supabase webhook on `exports` DELETE

**Steps:**
1. Delete `asset_path` file from storage

## BuildShip Setup

1. Create BuildShip account/project
2. Add Supabase integration (service role key)
3. Create webhook endpoints for each workflow
4. Configure Supabase webhooks to point to BuildShip URLs

## Tasks

- [ ] Create Workflow A (layering job)
- [ ] Create Workflow B (cleanup)
- [ ] Create Workflow C (export builder)
- [ ] Test end-to-end: INSERT project → layers appear
- [ ] Test cleanup: DELETE project → storage cleared

## Verification

- [ ] INSERT project with queued status triggers Workflow A
- [ ] Layers appear in project_layers table after processing
- [ ] DELETE project removes all storage files
- [ ] INSERT export creates downloadable artifact
