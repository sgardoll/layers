# Plan 02.1-01: Supabase Schema

## Objective
Set up Supabase project with database schema for projects, layers, and exports.

## Tables

### `projects`
| Column | Type | Notes |
|--------|------|-------|
| id | uuid | PK, default gen_random_uuid() |
| user_id | uuid | nullable (anonymous users) |
| source_image_path | text | Storage path to uploaded original |
| source_image_url | text | nullable, signed/public URL |
| status | text | queued → processing → packaging → ready → failed |
| error_message | text | nullable |
| params | jsonb | model parameters (layer_count, detail, etc.) |
| manifest_path | text | nullable, storage path to manifest.json |
| created_at | timestamptz | default now() |
| updated_at | timestamptz | default now() |

**Triggers:**
- INSERT → fires webhook to BuildShip "Run Layering Job"
- DELETE → fires webhook to BuildShip "Cleanup Project Assets"

### `project_layers`
| Column | Type | Notes |
|--------|------|-------|
| id | uuid | PK |
| project_id | uuid | FK → projects.id ON DELETE CASCADE |
| name | text | layer name |
| png_path | text | storage path to layer PNG |
| png_url | text | nullable, signed URL |
| width | int | |
| height | int | |
| z_index | int | layer order |
| visible | bool | default true |
| bbox | jsonb | nullable, {x, y, width, height} |
| transform | jsonb | nullable, {x, y, scale, rotation, opacity} |
| created_at | timestamptz | default now() |

**Triggers:** None (cascade delete handles cleanup)

### `exports`
| Column | Type | Notes |
|--------|------|-------|
| id | uuid | PK |
| project_id | uuid | FK → projects.id ON DELETE CASCADE |
| type | text | pngs, zip, layersPack |
| status | text | queued → processing → ready → failed |
| options | jsonb | {layerIds: [...]} |
| asset_path | text | nullable, storage path |
| asset_url | text | nullable, signed URL |
| error_message | text | nullable |
| created_at | timestamptz | default now() |
| updated_at | timestamptz | default now() |

**Triggers:**
- INSERT → fires webhook to BuildShip "Build Export"
- DELETE → fires webhook to BuildShip "Cleanup Export"

## Storage Buckets

1. **`source-images`** - uploaded original images
2. **`layers`** - generated layer PNGs  
3. **`exports`** - export artifacts (ZIPs, .layers packs)
4. **`manifests`** - manifest.json files

## RLS Policies

For MVP (anonymous users):
- All tables: public read/write (tighten later with auth)

## Tasks

- [ ] Create Supabase project
- [ ] Run migration SQL for all tables
- [ ] Create storage buckets with public access
- [ ] Set up database webhooks pointing to BuildShip
- [ ] Test INSERT trigger fires webhook

## Verification

- [ ] Can INSERT into projects → webhook fires
- [ ] Can query project_layers by project_id
- [ ] Storage upload returns valid path
- [ ] DELETE cascades properly
