# Plan 03-01: 3D Layer Space View

## Goal
Build the signature "3D cards in space" viewer - the core differentiator of Layers app.

## Research Summary
- **Perspective**: `Matrix4.identity()..setEntry(3, 2, 0.001)` creates perspective projection
- **Transforms**: Combine rotateX, rotateY, translate for layer positioning
- **Gestures**: GestureDetector with onScaleUpdate for orbit (rotation + zoom), onPanUpdate for pan
- **Hit testing**: Flutter handles hit testing on transformed widgets automatically

## Architecture

### Camera State
```dart
class CameraState {
  final double rotationX;  // Pitch: -45° to 45°
  final double rotationY;  // Yaw: -180° to 180°
  final double zoom;       // 0.5 to 2.0
  final Offset pan;        // Center offset
}
```

### Layer Positioning
Each layer is positioned along Z-axis with spacing:
- Layer 0 (bottom): z = 0
- Layer 1: z = layerSpacing
- Layer N: z = N * layerSpacing

Default spacing: 80px (adjustable via slider)

## Implementation Steps

### Step 1: Camera Controller
File: `lib/providers/camera_provider.dart`
- CameraState model with Freezed
- CameraNotifier extends StateNotifier
- Methods: rotate(dx, dy), zoom(scale), pan(offset), reset()
- Clamp values to valid ranges

### Step 2: Layer Space Widget
File: `lib/widgets/layer_space/layer_space_view.dart`
- Consumes CameraState from provider
- Builds perspective matrix from camera angles
- Wraps children in Transform widget

### Step 3: Layer Card Widget
File: `lib/widgets/layer_space/layer_card.dart`
- Displays single layer image with CachedNetworkImage
- Applies per-layer Z translation
- Handles selection tap
- Shows selection border when selected

### Step 4: Gesture Handler
File: `lib/widgets/layer_space/layer_space_gestures.dart`
- Two-finger drag → rotate camera (orbit)
- Pinch → zoom
- Single tap on layer → select
- Double tap → reset camera
- Pan (single finger on empty space) → pan view

### Step 5: Integration
File: `lib/screens/layers_screen.dart`
- Replace placeholder with LayerSpaceView
- Connect to layers provider
- Add layer spacing slider in app bar

## Matrix Math

```dart
Matrix4 buildProjectionMatrix(CameraState camera) {
  return Matrix4.identity()
    // Perspective
    ..setEntry(3, 2, 0.001)
    // Apply camera transforms
    ..translate(camera.pan.dx, camera.pan.dy)
    ..scale(camera.zoom)
    ..rotateX(camera.rotationX)
    ..rotateY(camera.rotationY);
}

Matrix4 buildLayerMatrix(int index, double spacing) {
  return Matrix4.identity()
    ..translate(0.0, 0.0, index * spacing);
}
```

## Acceptance Criteria
- [ ] Layers display as stacked cards with visible depth
- [ ] Two-finger drag orbits the view smoothly (60fps)
- [ ] Pinch zooms in/out
- [ ] Tapping a layer selects it (visual feedback)
- [ ] Double-tap resets to default view
- [ ] Layer spacing adjustable via slider
- [ ] Works on all platforms (touch + mouse)

## Performance Notes
- Use RepaintBoundary around each layer card
- Limit layer count display (virtualize if >20 layers)
- Cache transformed images where possible

## Files to Create
1. `lib/providers/camera_provider.dart`
2. `lib/models/camera_state.dart`
3. `lib/widgets/layer_space/layer_space_view.dart`
4. `lib/widgets/layer_space/layer_card.dart`
5. `lib/widgets/layer_space/layer_space_gestures.dart`

## Dependencies
- flutter_riverpod (existing)
- cached_network_image (existing)
- vector_math (add for Matrix4 helpers)
