---
phase: 15.1-anonymous-rls-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  supabase/migrations/20260124_add_rls_policies.sql,
  supabase/migrations/20260201_anonymous_storage_policies.sql,
  lib/services/supabase_project_service.dart
]
autonomous: true
---

<objective>
Fix Supabase RLS policies to allow anonymous (non-logged-in) users to create projects.

Purpose: Users should be able to start a new project without requiring authentication. The schema.sql has correct policies supporting `user_id IS NULL` for anonymous projects, but the migration file was never updated to match.

Output: Updated migration files that allow anonymous project creation, and verified working end-to-end flow.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/schema.sql
@supabase/migrations/20260124_add_rls_policies.sql
@lib/services/supabase_project_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update RLS migration to support anonymous projects</name>
  <files>supabase/migrations/20260124_add_rls_policies.sql</files>
  <action>Update the RLS policies in the migration file to match schema.sql which supports anonymous users. Key changes needed:

1. Projects table policies (lines 15-32): Change all four policies (SELECT, INSERT, UPDATE, DELETE) from `auth.uid() = user_id` to `auth.uid() = user_id OR user_id IS NULL`. This allows anonymous users (where user_id is NULL) to create and manage projects.

2. Project_layers table policies (lines 44-86): Update all four policies to check `(projects.user_id = auth.uid() OR projects.user_id IS NULL)` instead of just `projects.user_id = auth.uid()`. This allows BuildShip and anonymous users to work with layers of anonymous projects.

3. Exports table policies (lines 99-127): Same change as project_layers - update to support `OR projects.user_id IS NULL`.

The schema.sql already has these correct policies (lines 156-249) - copy those exact policy definitions into the migration file, keeping the DROP POLICY IF EXISTS statements for idempotency.

Maintain the migration idempotency pattern: DROP POLICY IF EXISTS first, then CREATE POLICY.</action>
  <verify>Diff the migration file against schema.sql policies section - all policy definitions should match the `OR user_id IS NULL` pattern for anonymous support</verify>
  <done>Migration file updated with anonymous-friendly RLS policies that match schema.sql</done>
</task>

<task type="auto">
  <name>Task 2: Add storage policies for anonymous uploads</name>
  <files>supabase/migrations/20260201_anonymous_storage_policies.sql</files>
  <action>Create a new migration file for storage bucket policies that allow anonymous uploads to the source-images bucket.

Create `supabase/migrations/20260201_anonymous_storage_policies.sql` with:

1. Enable RLS on storage.objects if not already enabled
2. Drop existing storage policies for source-images bucket to ensure idempotency
3. Create INSERT policy allowing anonymous uploads: `(bucket_id = 'source-images') AND ((storage.foldername(name))[1] = 'anonymous' OR auth.uid()::text = (storage.foldername(name))[1])`
4. Create SELECT policy allowing anonymous reads: same condition as INSERT
5. Create DELETE policy: same condition as INSERT

The key insight: anonymous users currently store files under 'anonymous/' folder (see supabase_project_service.dart line 18: `_userId` returns 'anonymous' when not logged in). The policy should allow access to files in the 'anonymous' folder without requiring authentication.

Note: Storage policies use different syntax than table policies. Use `storage.foldername(name)[1]` to get the first path segment (the user folder).</action>
  <verify>Migration file exists with proper storage policies for anonymous folder access</verify>
  <done>Storage migration created allowing anonymous uploads to 'anonymous/' folder in source-images bucket</done>
</task>

<task type="auto">
  <name>Task 3: Verify service handles anonymous user correctly</name>
  <files>lib/services/supabase_project_service.dart</files>
  <action>Verify the SupabaseProjectService correctly handles anonymous users. Check:

1. Line 18: `_userId` getter returns '_client.auth.currentUser?.id ?? 'anonymous'' - this should remain as-is since it already handles anonymous
2. Line 38: When inserting project, user_id is set to `_client.auth.currentUser?.id` which will be NULL for anonymous - this is correct and matches the RLS policies
3. Line 29: Storage path uses `$_userId` which will be 'anonymous' for unauthenticated users - this matches our storage policy

No changes needed to the Dart code - it already handles anonymous users correctly. The issue was purely in the RLS policies. Add a code comment on line 38 explaining that NULL user_id is intentional for anonymous projects and is supported by RLS policies.</action>
  <verify>Code review confirms Dart service correctly handles anonymous users with no functional changes needed</verify>
  <done>Verified SupabaseProjectService handles anonymous users correctly, added explanatory comment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration files updated with `OR user_id IS NULL` pattern
- [ ] Storage policies created for anonymous folder access
- [ ] All SQL syntax validated (no syntax errors)
- [ ] Policies match between migration and schema.sql
- [ ] Code comment added explaining anonymous project support
</verification>

<success_criteria>

- RLS migration updated to support anonymous projects (user_id IS NULL)
- Storage policies created allowing anonymous uploads to 'anonymous/' folder
- SupabaseProjectService verified to handle anonymous users correctly
- All policy definitions consistent between migration and schema.sql
- Ready for deployment to Supabase
  </success_criteria>

<output>
After completion, create `.planning/phases/15.1-anonymous-rls-fix/15.1-01-SUMMARY.md`

SUMMARY.md should document:
- What RLS policies were changed and why
- Storage policies added for anonymous access
- Verification that anonymous project creation now works
- Deployment instructions (run migrations in Supabase SQL Editor)
</output>
