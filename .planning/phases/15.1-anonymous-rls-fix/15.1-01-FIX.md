# Emergency Fix Plan: Phase 15.1 Critical Regressions

**Date:** 2026-02-03  
**Status:** üî¥ CRITICAL - BLOCKING RELEASE  
**Source:** Logout fix (2026-02-01, commit 1f6210b) introduced regressions

---

## Issues Being Fixed

| Issue | Severity | Description |
|-------|----------|-------------|
| **UAT-003** | üî¥ CRITICAL - BILLING FRAUD | New/anonymous users incorrectly shown as Pro after Pro user logs out |
| **UAT-002** | üî¥ CRITICAL | Pro users incorrectly show as "Free" in Settings |
| **UAT-004** | üî¥ CRITICAL | Projects don't appear after login |
| **UAT-001** | üî¥ BLOCKER | Anonymous project creation fails silently |
| **UAT-005** | üü° MAJOR | 3D viewer schematic labels reversed |

---

## Root Cause Analysis

### The Core Problem: Race Conditions in Provider Lifecycle

The logout fix (commit 1f6210b) introduced `linkedRevenueCatServiceProvider` to properly scope RevenueCat to authenticated users. However, it created several race conditions:

### 1. **RevenueCat State Not Properly Reset on Logout (UAT-003)**

**The Bug:**
```dart
// linkedRevenueCatServiceProvider - entitlement_provider.dart lines 57-70
final linkedRevenueCatServiceProvider = FutureProvider<RevenueCatService>((ref) async {
  final service = ref.watch(revenueCatServiceProvider);
  final user = ref.watch(currentUserProvider);

  if (user != null) {
    await service.logIn(user.id);  // Links to user
  }
  // BUG: When user is null, we DON'T call service.logOut()!
  
  return service;
});
```

**What Happens:**
1. Pro user is logged in ‚Üí RevenueCat linked to their account ‚Üí has Pro entitlement
2. User logs out ‚Üí `settings_screen.dart` calls `revenueCatService.logOut()`
3. But `linkedRevenueCatServiceProvider` rebuilds because `currentUserProvider` changed
4. Since `user == null`, it skips the login block but **doesn't call logOut()**
5. RevenueCat SDK may still have cached Pro state from previous session
6. New/anonymous user opens app ‚Üí sees cached Pro status ‚Üí **BILLING FRAUD**

### 2. **Race Condition in Entitlement Checking (UAT-002)**

**The Bug:**
```dart
// entitlementProvider - lines 74-90
final entitlementProvider = StateNotifierProvider<EntitlementNotifier, EntitlementState>((ref) {
  final linkedServiceAsync = ref.watch(linkedRevenueCatServiceProvider);
  
  // BUG: Uses valueOrNull which may be null while linked service is loading
  final revenueCatService = linkedServiceAsync.valueOrNull ?? ref.read(revenueCatServiceProvider);
  
  return EntitlementNotifier(
    revenueCatService: revenueCatService!,
    // ...
  );
});
```

**What Happens:**
1. User logs in ‚Üí `linkedRevenueCatServiceProvider` starts async `logIn()` call
2. `entitlementProvider` rebuilds immediately with `valueOrNull = null`
3. Falls back to unlinked `revenueCatServiceProvider`
4. Entitlement check runs before `logIn()` completes
5. RevenueCat returns stale/anonymous entitlements (Free)
6. UI shows "Free" even though user is Pro

### 3. **Providers Not Re-initializing After Login (UAT-004, UAT-001)**

**The Bug:**
```dart
// settings_screen.dart lines 419-422
ref.invalidate(entitlementProvider);
ref.invalidate(projectListProvider);
ref.invalidate(layerProvider);
ref.invalidate(currentProjectProvider);
```

**What Happens:**
1. User logs out ‚Üí providers invalidated ‚Üí state reset
2. User logs back in ‚Üí providers should rebuild
3. But `projectListProvider` doesn't auto-load projects on creation
4. Projects tab shows empty state even when user has projects
5. Same issue affects anonymous mode project creation

### 4. **Schematic Labels Indexing (UAT-005)**

**The Bug:**
```dart
// layer_space_view.dart lines 76-77
final sortedLayers = [...widget.layers]..sort((a, b) => a.zIndex.compareTo(b.zIndex));
// index 0 = lowest zIndex = back of stack

// layer_card_3d.dart line 103
Text(layer.name ?? 'Layer ${index + 1}')  // index 0 shows "Layer 1"
```

**What Happens:**
- Layers sorted by zIndex ascending (0, 1, 2, 3...)
- Back layer (zIndex=0) gets index=0 ‚Üí labeled "Layer 1"
- Front layer (zIndex=3) gets index=3 ‚Üí labeled "Layer 4"
- User expectation: Layer 1 should be in **front**, not back
- **Visual vs. label mismatch**

---

## Fixes Required

### Fix 1: RevenueCat Logout on Anonymous State (UAT-003) ‚≠ê PRIORITY 1

**File:** `lib/providers/entitlement_provider.dart`

**Change:** Modify `linkedRevenueCatServiceProvider` to explicitly log out when user is null.

```dart
/// Provider that links RevenueCat to the current authenticated user
/// This ensures RevenueCat customer info is properly scoped to the user
final linkedRevenueCatServiceProvider = FutureProvider<RevenueCatService>((
  ref,
) async {
  final service = ref.watch(revenueCatServiceProvider);
  final user = ref.watch(currentUserProvider);

  if (user != null) {
    // Link this RevenueCat session to the authenticated user
    await service.logIn(user.id);
    debugPrint('RevenueCat: Linked to user ${user.id}');
  } else {
    // CRITICAL FIX: Explicitly log out when user is null (anonymous)
    // This prevents cached Pro entitlements from leaking to new/anonymous users
    await service.logOut();
    debugPrint('RevenueCat: Logged out for anonymous session');
  }

  return service;
});
```

**Why This Fixes UAT-003:**
- When Pro user logs out, `currentUserProvider` becomes null
- `linkedRevenueCatServiceProvider` rebuilds and calls `logOut()`
- RevenueCat SDK clears cached entitlements
- New/anonymous users get fresh anonymous session = always Free

---

### Fix 2: Wait for Linked Service Before Entitlement Check (UAT-002) ‚≠ê PRIORITY 1

**File:** `lib/providers/entitlement_provider.dart`

**Change:** Handle async loading state in entitlement provider and re-check when linked service is ready.

```dart
/// Provider for entitlement state
/// Watches the linked RevenueCat service so it re-initializes when user changes
final entitlementProvider =
    StateNotifierProvider<EntitlementNotifier, EntitlementState>((ref) {
      final linkedServiceAsync = ref.watch(linkedRevenueCatServiceProvider);
      final projectListState = ref.watch(projectListProvider);

      // CRITICAL FIX: Wait for linked service to complete before using it
      // If it's still loading, we'll get a notifier that waits for it
      final notifier = EntitlementNotifier(
        revenueCatService: linkedServiceAsync.valueOrNull,
        projectCount: projectListState.projects.length,
      );
      
      // If linked service is still loading, mark as loading
      if (linkedServiceAsync.isLoading) {
        notifier.setLoading();
      }
      
      return notifier;
    });

class EntitlementNotifier extends StateNotifier<EntitlementState> {
  RevenueCatService? _revenueCatService;

  EntitlementNotifier({
    required RevenueCatService? revenueCatService,
    required int projectCount,
  }) : _revenueCatService = revenueCatService,
       super(EntitlementState(projectCount: projectCount)) {
    _init();
  }

  void setLoading() {
    state = state.copyWith(isLoading: true);
  }

  Future<void> _init() async {
    // If service not ready yet, we'll check later when provider rebuilds
    if (_revenueCatService == null) {
      state = state.copyWith(isLoading: true);
      return;
    }
    await checkEntitlements();
  }
  
  // ... rest of class
}
```

**Alternative Approach (Simpler):**
```dart
// In entitlementProvider, don't use the linked service until it's ready
final entitlementProvider = StateNotifierProvider<EntitlementNotifier, EntitlementState>((ref) {
  final linkedServiceAsync = ref.watch(linkedRevenueCatServiceProvider);
  final projectListState = ref.watch(projectListProvider);

  // Only proceed when linked service is loaded
  // This provider will auto-rebuild when linkedServiceAsync completes
  if (linkedServiceAsync.isLoading || linkedServiceAsync.hasError) {
    // Return a notifier in loading state
    return EntitlementNotifier.loading(projectCount: projectListState.projects.length);
  }

  return EntitlementNotifier(
    revenueCatService: linkedServiceAsync.requireValue,
    projectCount: projectListState.projects.length,
  );
});
```

**Why This Fixes UAT-002:**
- Entitlement check waits for `linkedRevenueCatServiceProvider` to complete
- No race condition between login and entitlement check
- Pro users will correctly see Pro status

---

### Fix 3: Auto-Load Projects on Auth State Change (UAT-004) ‚≠ê PRIORITY 1

**File:** `lib/providers/project_provider.dart`

**Change:** Add auth state listener to auto-load projects when user logs in.

```dart
class ProjectListNotifier extends StateNotifier<ProjectListState> {
  final SupabaseProjectService _service;
  final Ref? _ref;  // Add ref to watch auth state
  final Map<String, StreamSubscription<Project>> _subscriptions = {};
  StreamSubscription? _authSubscription;

  ProjectListNotifier(this._service, {Ref? ref}) : _ref = ref, super(const ProjectListState()) {
    _init();
  }

  void _init() {
    // If we have a ref, listen to auth changes
    _ref?.listen(currentUserProvider, (previous, current) {
      if (previous == null && current != null) {
        // User just logged in - load their projects
        debugPrint('ProjectListNotifier: User logged in, loading projects');
        loadProjects();
      } else if (previous != null && current == null) {
        // User just logged out - clear projects
        debugPrint('ProjectListNotifier: User logged out, clearing projects');
        reset();
      }
    });
    
    // Also load on initial creation if authenticated
    final user = _ref?.read(currentUserProvider);
    if (user != null) {
      loadProjects();
    }
  }
  
  // ... rest of class
  
  @override
  void dispose() {
    _authSubscription?.cancel();
    // ... rest of dispose
  }
}

// Update provider to pass ref
final projectListProvider =
    StateNotifierProvider<ProjectListNotifier, ProjectListState>((ref) {
      final service = ref.watch(supabaseProjectServiceProvider);
      return ProjectListNotifier(service, ref: ref);
    });
```

**Why This Fixes UAT-004:**
- Projects auto-load when user logs in
- No manual refresh needed
- User sees their projects immediately after login

---

### Fix 4: Ensure Anonymous Mode Works (UAT-001) ‚≠ê PRIORITY 1

**File:** `lib/providers/project_provider.dart` (same as Fix 3)

**Additional Change:** Ensure empty state is shown when logged out.

```dart
// In ProjectListNotifier._init()
void _init() {
  _ref?.listen(currentUserProvider, (previous, current) {
    if (previous == null && current != null) {
      loadProjects();
    } else if (previous != null && current == null) {
      reset();
    }
  });
  
  // For anonymous users, we should show empty state
  // The state is already initialized as empty, so this is correct
}
```

**File:** `lib/screens/project_screen.dart` (or wherever empty state widget is)

**Verify:** Empty state widget shows when `user == null`.

```dart
// In project screen build method
final user = ref.watch(currentUserProvider);
final projectState = ref.watch(projectListProvider);

if (user == null) {
  // Show anonymous empty state with upload prompt
  return AnonymousEmptyState(
    onUpload: () => _showImagePicker(),
  );
}

if (projectState.projects.isEmpty) {
  return LoggedInEmptyState(
    onCreateProject: () => _showImagePicker(),
  );
}

// Show project list
return ProjectList(projects: projectState.projects);
```

**Why This Fixes UAT-001:**
- Anonymous users see proper empty state
- Image upload can trigger project creation
- Provider properly handles anonymous mode

---

### Fix 5: Fix Schematic Label Ordering (UAT-005)

**File:** `lib/widgets/layer_card_3d.dart`

**Change:** Reverse the index for display so Layer 1 is in front.

```dart
Positioned(
  left: 8,
  bottom: 8,
  child: Container(
    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
    decoration: BoxDecoration(
      color: Colors.black.withOpacity(0.7),
      borderRadius: BorderRadius.circular(4),
    ),
    child: Text(
      // FIX: Display layer number based on reverse index
      // Layer 1 should be the FRONT-most layer (highest zIndex)
      layer.name ?? 'Layer ${totalLayers - index}',
      style: const TextStyle(
        color: Colors.white,
        fontSize: 12,
        fontWeight: FontWeight.w500,
      ),
    ),
  ),
);
```

**Alternative Fix (if zIndex-based is preferred):**
```dart
// If using zIndex directly:
layer.name ?? 'Layer ${layer.zIndex + 1}'
```

**Why This Fixes UAT-005:**
- With 4 layers: index 0,1,2,3 (back to front)
- Old: "Layer 1", "Layer 2", "Layer 3", "Layer 4" (back to front) ‚ùå
- New: "Layer 4", "Layer 3", "Layer 2", "Layer 1" (back to front) ‚úì
- User expectation: Layer 1 is the front-most layer

---

## Testing Plan

### Pre-Requisites
1. Ensure you have both Pro and Free test accounts
2. Clear app data/cache between tests
3. Have projects in both accounts for UAT-004 testing

### Test Sequence

#### Test 1: Billing Fraud Prevention (UAT-003) üî¥ CRITICAL
```
1. Log in as Pro user
2. Verify "Pro" shown in Settings
3. Log out
4. DO NOT close app
5. Check Settings ‚Üí Should show "Free"
6. Close app completely
7. Reopen app (as anonymous)
8. Check Settings ‚Üí Should show "Free" (NOT Pro)
9. Create new account
10. Check Settings ‚Üí Should show "Free"
PASS: Anonymous/new users never see Pro
FAIL: If Pro status shown = BILLING FRAUD
```

#### Test 2: Pro User Display (UAT-002) üî¥ CRITICAL
```
1. Log in as Pro user
2. Open Settings immediately
3. Should show "Pro" (not loading indefinitely, not "Free")
4. Try to upgrade ‚Üí Should show "You're currently subscribed"
PASS: Pro status correctly displayed
FAIL: Shows "Free" or stuck loading
```

#### Test 3: Projects After Login (UAT-004) üî¥ CRITICAL
```
1. Log in as user with projects
2. Open Projects tab
3. Projects should appear within 2-3 seconds
4. Log out
5. Log back in as same user
6. Projects should appear again
7. Log in as different user
8. Should see THAT user's projects
PASS: Correct projects load after each login
FAIL: Empty state shown, wrong user's projects
```

#### Test 4: Anonymous Project Creation (UAT-001) üî¥ BLOCKER
```
1. Ensure logged out (fresh app start)
2. Go to Projects tab
3. Should see empty state with upload prompt
4. Tap upload, select image
5. Project should be created and appear in list
6. Complete extraction flow
7. Project should remain in list
PASS: Full flow works while logged out
FAIL: Project never appears, no error shown
```

#### Test 5: Schematic Labels (UAT-005) üü° MAJOR
```
1. Open any project with multiple layers
2. Go to 3D view
3. Front-most layer should be labeled "Layer 1"
4. Back-most layer should be highest number
5. Visual layer order should match labels
PASS: Labels match visual order (Layer 1 in front)
FAIL: Labels reversed (Layer 1 in back)
```

#### Regression Test: Logout Still Works
```
1. Log in as Pro user
2. Create a project
3. Log out
4. Verify app returns to auth screen
5. Verify no user data visible
PASS: Clean logout, no data leakage
FAIL: Stuck on loading, data still visible
```

---

## Rollback Option

If fixes cannot be completed quickly:

### Option A: Revert Logout Fix (Safest)
```bash
# Revert the specific commit
git revert 1f6210b

# Or manually remove linkedRevenueCatServiceProvider
# and restore original entitlementProvider
```

**Trade-offs:**
- ‚úÖ Fixes all regressions immediately
- ‚ùå Re-introduces original logout bug (RevenueCat state leak)
- ‚ùå Requires re-testing original logout flow

### Option B: Disable Anonymous Mode (Temporary)
```dart
// Force login for all features
if (user == null) {
  return AuthRequiredScreen();
}
```

**Trade-offs:**
- ‚úÖ Eliminates UAT-003 (billing fraud)
- ‚úÖ Eliminates UAT-001 (anonymous creation)
- ‚ùå Major UX degradation
- ‚ùå Still has UAT-002 and UAT-004 issues

### Option C: Emergency Hotfix (Minimal)
Only apply Fix 1 (UAT-003) and ship:
```dart
// In linkedRevenueCatServiceProvider, just add the else block
else {
  await service.logOut();
}
```

**Trade-offs:**
- ‚úÖ Fixes critical billing fraud
- ‚ùå Other issues remain
- ‚ö†Ô∏è May introduce new issues

---

## Implementation Order

1. **Fix 1 (UAT-003)** - Billing fraud is showstopper
2. **Fix 2 (UAT-002)** - Revenue display critical
3. **Fix 3 (UAT-004)** - Core functionality
4. **Fix 4 (UAT-001)** - Anonymous mode
5. **Fix 5 (UAT-005)** - UI polish

---

## Files to Modify

| File | Lines | Change |
|------|-------|--------|
| `lib/providers/entitlement_provider.dart` | 57-70 | Fix 1: Add else block with logOut() |
| `lib/providers/entitlement_provider.dart` | 74-90 | Fix 2: Handle loading state |
| `lib/providers/project_provider.dart` | 39-66 | Fix 3: Add auth listener |
| `lib/providers/project_provider.dart` | 162-166 | Fix 3: Pass ref to notifier |
| `lib/widgets/layer_card_3d.dart` | 103 | Fix 5: Reverse index in label |

---

## Verification Checklist

- [ ] UAT-003: Anonymous users see "Free"
- [ ] UAT-003: New users see "Free"
- [ ] UAT-003: After Pro logout, new users don't inherit Pro
- [ ] UAT-002: Pro users see "Pro"
- [ ] UAT-002: No infinite loading on Settings
- [ ] UAT-004: Projects appear after login
- [ ] UAT-004: Correct user's projects shown
- [ ] UAT-001: Anonymous empty state visible
- [ ] UAT-001: Anonymous project creation works
- [ ] UAT-005: Layer 1 is front-most in 3D view
- [ ] Regression: Logout still clears all state
- [ ] Regression: Login still works

---

## Notes for Developers

1. **Riverpod Behavior:** Remember that `FutureProvider` rebuilds when dependencies change, but `.valueOrNull` may be null during loading. Always handle loading states explicitly.

2. **RevenueCat Lifecycle:** RevenueCat SDK maintains its own cache. Calling `logOut()` is essential to clear this cache between users.

3. **Provider Dependencies:** `entitlementProvider` ‚Üí `linkedRevenueCatServiceProvider` ‚Üí `currentUserProvider`. Changes to auth state cascade through all three.

4. **Testing Tip:** Use `debugPrint` liberally during testing to trace provider rebuilds and RevenueCat state changes.

---

*Plan Version: 1.0*  
*Created: 2026-02-03*  
*Next Review: After fixes implemented*
