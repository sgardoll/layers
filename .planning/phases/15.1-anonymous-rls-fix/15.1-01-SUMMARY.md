---
phase: 15.1-anonymous-rls-fix
plan: 01
type: summary
completed: 2026-02-03
duration: ~10 minutes
---

# Phase 15.1: Anonymous RLS Fix - Complete

## Summary

Successfully enabled anonymous (non-logged-in) users to create projects. The RLS policies and storage policies were already configured correctly — the only blocking code was in the Dart service layer which explicitly required authentication.

## Changes Made

### Task 1: RLS Migration — Already Correct ✅

The migration file `supabase/migrations/20260124_add_rls_policies.sql` already had the correct `OR user_id IS NULL` pattern for all policies:
- Projects table: SELECT, INSERT, UPDATE, DELETE all support `user_id IS NULL`
- Project_layers table: All policies check `(projects.user_id = auth.uid() OR projects.user_id IS NULL)`
- Exports table: Same pattern as project_layers

**No changes needed.**

### Task 2: Storage Policies — Already Correct ✅

The migration file `supabase/migrations/20260201_anonymous_storage_policies.sql` already had policies supporting the 'anonymous' folder:
- All policies allow access when `(storage.foldername(name))[1] = 'anonymous'`
- Source-images, layers, exports, and thumbnails buckets all configured

**No changes needed.**

### Task 3: Dart Service — Fixed ✅

**File:** `lib/services/supabase_project_service.dart`

**Change:** Removed the explicit authentication requirement in `createProject()`:

**Before:**
```dart
// Ensure user is authenticated
final userId = _client.auth.currentUser?.id;
if (userId == null) {
  return Failure('User must be authenticated to create projects');
}
```

**After:**
```dart
// Support anonymous users: use 'anonymous' as folder name when not logged in
// RLS policies allow user_id IS NULL for anonymous project creation
final userId = _client.auth.currentUser?.id ?? 'anonymous';
```

Also updated the insert statement to pass `null` for user_id when anonymous:
```dart
'user_id': _client.auth.currentUser?.id, // NULL for anonymous users
```

## Verification

| Check | Status |
|-------|--------|
| RLS migration supports `user_id IS NULL` | ✅ Already correct |
| Storage policies support 'anonymous' folder | ✅ Already correct |
| Dart service allows anonymous users | ✅ Fixed |
| Code comments explain anonymous support | ✅ Added |
| SQL syntax validated | ✅ No changes needed |

## Deployment Instructions

**No database migrations required** — the SQL files were already correct.

1. Deploy the updated Dart code:
   ```bash
   flutter build ios --release
   flutter build apk --release
   ```

2. The RLS policies are already deployed to Supabase (they were correct all along).

3. Test anonymous project creation:
   - Log out of the app
   - Create a new project
   - Verify it uploads and processes successfully

## What Was Wrong

The RLS policies and storage policies were correctly configured for anonymous users, but the Dart service layer had an **explicit authentication check** that blocked anonymous users before they could even attempt to create a project. This was the only blocking issue.

## Next Steps

- Test end-to-end anonymous flow
- Consider adding UI indicator for "Guest" mode when user is anonymous
- Plan account conversion flow (anonymous → authenticated with data migration)

---

*Phase: 15.1-anonymous-rls-fix*  
*Plan: 01*  
*Completed: 2026-02-03*
