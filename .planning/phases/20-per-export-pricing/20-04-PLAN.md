---
phase: 20-per-export-pricing
plan: 04
type: execute
wave: 3
depends_on: ["20-03"]
files_modified: [
  "lib/screens/export_bottom_sheet.dart",
  "lib/widgets/credit_indicator.dart"
]
autonomous: true
domain: flutter
---

<objective>
Create export bottom sheet with credit check logic and consumption at export time.

Purpose: Enable per-export pricing by checking and consuming credits when users export layers.
Output: Export bottom sheet widget with credit display, purchase prompt when credits = 0, and credit consumption on successful export.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/providers/credits_provider.dart
@lib/providers/entitlement_provider.dart
@lib/screens/paywall_screen.dart

**Requirements from ROADMAP:**
- MON-01: User can purchase single export credit for $0.50
- MON-02: Credit consumed at moment of export (not purchase)
- MON-04: Clear price display with configure-before-pay flow

**Key decisions from STATE.md:**
- Bottom sheet pattern for mobile secondary UI (feels more natural than drawer)
- Design system uses Inter font via Google Fonts
- Dual theme system: Light (clean/airy) and Dark (immersive navy with cyan glow)

**Existing patterns:**
- PaywallScreen uses ConsumerStatefulWidget with Riverpod
- Bottom sheets in Flutter use showModalBottomSheet
- Credit consumption happens AFTER user confirms export, not at purchase
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CreditIndicator widget</name>
  <files>lib/widgets/credit_indicator.dart</files>
  <action>
Create reusable CreditIndicator widget to display credit balance throughout the app:

Widget structure:
- Small chip/badge showing current credit count
- Icon (coins or credit_card) + number
- Variants: compact (just icon + count), expanded (with "credits" label)
- Loading state when credits loading
- Tap to show credit info tooltip or navigate to purchase

Constructor:
```dart
const CreditIndicator({
  super.key,
  this.variant = CreditIndicatorVariant.compact,
  this.onTap,
  this.showPurchaseButton = false,
});
```

Styling:
- Use Theme.of(context).colorScheme
- Follow design system colors (#1C39EC, #00A9FE from app icon)
- Light theme: clean/airy with generous whitespace
- Dark theme: immersive navy with cyan glow

Integration with Riverpod:
- Watch creditsProvider
- Display creditsRemaining
- Show "Get Credits" button when 0 credits if showPurchaseButton=true
  </action>
  <verify>Widget renders without errors; handles loading and zero states</verify>
  <done>Reusable credit indicator widget created with variants and theme support</done>
</task>

<task type="auto">
  <name>Task 2: Create ExportBottomSheet</name>
  <files>lib/screens/export_bottom_sheet.dart</files>
  <action>
Create ExportBottomSheet widget for configuring and initiating exports:

**Structure:**
StatefulWidget with ConsumerState for Riverpod access

**Sections:**
1. Header with title "Export Layers" and close button
2. Credit indicator (from Task 1) showing current balance
3. Export format selection (PNG, ZIP - future: .layers, PSD)
4. Quality/scale options (if applicable)
5. Export button with dynamic state:
   - "Export (1 credit)" - if has credits
   - "Buy Credit ($0.50)" - if 0 credits
   - Loading state during export

**Credit check logic:**
```dart
void _onExportPressed() async {
  final hasCredits = ref.read(hasCreditsProvider);
  
  if (!hasCredits) {
    // Show purchase prompt
    final purchased = await _showPurchaseDialog();
    if (!purchased) return;
  }
  
  // Consume credit and proceed with export
  final consumed = await ref.read(creditsProvider.notifier).consumeCredit(
    projectId: widget.projectId,
    description: 'Export: ${widget.projectName}',
  );
  
  if (consumed) {
    await _performExport();
  }
}
```

**UI States:**
- Normal: Show credit count, enable export button
- Zero credits: Show "Buy Credit" button, disable export
- Loading: Show progress indicator
- Error: Show error message with retry

**Props:**
```dart
final String projectId;
final String projectName;
final List<Layer> layers;
final VoidCallback? onExportComplete;
```

Follow bottom sheet pattern from STATE.md (mobile-friendly, more natural than drawer).
  </action>
  <verify>Bottom sheet opens, shows credit balance, handles export flow</verify>
  <done>Export bottom sheet with credit check and consumption logic</done>
</task>

</task>

<verification>
Before declaring plan complete:
- [ ] CreditIndicator widget displays balance correctly
- [ ] CreditIndicator handles loading and zero states
- [ ] ExportBottomSheet opens from any screen
- [ ] Credit balance checked before export
- [ ] Credit consumed atomically with export
- [ ] Purchase prompt shown when credits = 0
- [ ] UI follows design system (Inter font, theme colors)
- [ ] Responsive layout works on mobile/tablet
</verification>

<success_criteria>

- CreditIndicator reusable widget created
- ExportBottomSheet integrates with CreditsProvider
- Credit check happens before export initiation
- Credit consumed only on successful export start
- Purchase prompt shown when user has 0 credits
- UI follows established design system patterns
- Responsive layout for all screen sizes
  </success_criteria>

<output>
After completion, create `.planning/phases/20-per-export-pricing/20-04-SUMMARY.md`
</output>
