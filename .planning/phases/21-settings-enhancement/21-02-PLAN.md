---
phase: 21-settings-enhancement
plan: 02
type: execute
depends_on: ["21-01"]
files_modified: [
  "lib/screens/settings_screen.dart"
]
autonomous: true
domain: flutter
---

<objective>
Enhance SettingsScreen with user info section, subscription status, and usage statistics.

Purpose: Display comprehensive user information including email, subscription tier, and export/project stats.
Output: Enhanced SettingsScreen with new sections following design system patterns.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/screens/settings_screen.dart
@lib/providers/entitlement_provider.dart
@lib/providers/stats_provider.dart
@lib/providers/credits_provider.dart
@lib/services/revenuecat_service.dart

**Requirements from ROADMAP:**
- SET-01: Settings displays current user email address
- SET-02: Settings shows subscription status (Free/Pro)
- SET-03: Settings displays export statistics (total exports, credits remaining)
- SET-04: "Manage Subscription" button deep-links to platform settings

**Key decisions from STATE.md:**
- Design system uses Inter font via Google Fonts
- Dual theme system: Light (clean/airy) and Dark (immersive navy)
- Theme colors from app icon (#1C39EC, #00A9FE)
- RevenueCat already integrated with logIn/logOut linking

**Existing patterns:**
- SettingsScreen already exists with basic structure
- PaywallScreen shows subscription status patterns
- ListTile-based settings UI
</context>

<tasks>

<task type="auto">
  <name>Add User Info Section</name>
  <files>lib/screens/settings_screen.dart</files>
  <action>
Add a new "Account" section at the top of SettingsScreen:

**User Info Card:**
```dart
Card(
  child: Padding(
    padding: const EdgeInsets.all(16.0),
    child: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // User email from Supabase auth
        Text(
          userEmail ?? 'Guest User',
          style: Theme.of(context).textTheme.titleMedium,
        ),
        const SizedBox(height: 4),
        // Join date
        Text(
          'Member since ${formatDate(joinedAt)}',
          style: Theme.of(context).textTheme.bodySmall,
        ),
      ],
    ),
  ),
)
```

**Implementation:**
- Get email from `Supabase.instance.client.auth.currentUser?.email`
- Get joinedAt from `Supabase.instance.client.auth.currentUser?.createdAt`
- Handle null case (logged out) - show "Sign in to see account details"
- Use existing card styling from design system
  </action>
  <verify>Email displays correctly for logged-in users</verify>
  <done>User info section with email and join date</done>
</task>

<task type="auto">
  <name>Add Subscription Status Section</name>
  <files>lib/screens/settings_screen.dart</files>
  <action>
Add "Subscription" section with status and management:

**Subscription Card:**
```dart
Card(
  child: Column(
    children: [
      ListTile(
        leading: Icon(
          isPro ? Icons.workspace_premium : Icons.person_outline,
          color: isPro ? theme.colorScheme.primary : null,
        ),
        title: Text(isPro ? 'Pro Subscription' : 'Free Plan'),
        subtitle: isPro 
          ? Text('Active until ${formatDate(expiryDate)}')
          : const Text('Upgrade for unlimited exports'),
        trailing: isPro 
          ? Chip(
              label: const Text('PRO'),
              backgroundColor: theme.colorScheme.primaryContainer,
            )
          : null,
      ),
      const Divider(height: 1),
      ListTile(
        leading: const Icon(Icons.settings),
        title: const Text('Manage Subscription'),
        trailing: const Icon(Icons.open_in_new),
        onTap: () => _openSubscriptionManagement(),
      ),
    ],
  ),
)
```

**Deep link implementation:**
```dart
Future<void> _openSubscriptionManagement() async {
  final revenueCat = ref.read(revenueCatServiceProvider);
  await revenueCat.presentCodeRedemptionSheet(); // iOS
  // OR
  await revenueCat.showManageSubscriptions(); // Cross-platform if available
}
```

**Notes:**
- Use EntitlementProvider to get Pro status
- Show "Free" badge with upgrade CTA for non-Pro users
- Tapping subscription row opens paywall for free users
- Tapping "Manage" opens platform subscription settings for Pro users
  </action>
  <verify>Subscription status shows correctly, manage button works</verify>
  <done>Subscription section with status and management button</done>
</task>

<task type="auto">
  <name>Add Usage Statistics Section</name>
  <files>lib/screens/settings_screen.dart</files>
  <action>
Add "Usage" section with stats from StatsProvider:

**Stats Grid:**
```dart
Card(
  child: Padding(
    padding: const EdgeInsets.all(16.0),
    child: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Usage Stats',
          style: Theme.of(context).textTheme.titleSmall,
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            _StatItem(
              icon: Icons.folder_outlined,
              value: stats.totalProjects.toString(),
              label: 'Projects',
            ),
            _StatItem(
              icon: Icons.download_outlined,
              value: stats.totalExports.toString(),
              label: 'Exports',
            ),
            _StatItem(
              icon: Icons.layers_outlined,
              value: stats.totalLayers.toString(),
              label: 'Layers',
            ),
          ],
        ),
        const Divider(height: 24),
        Row(
          children: [
            _StatItem(
              icon: Icons.token_outlined,
              value: stats.creditsRemaining.toString(),
              label: 'Credits Left',
              highlight: true,
            ),
            if (stats.lastExportAt != null)
              Expanded(
                child: Text(
                  'Last export: ${timeAgo(stats.lastExportAt!)}',
                  style: Theme.of(context).textTheme.bodySmall,
                ),
              ),
          ],
        ),
      ],
    ),
  ),
)
```

**Private widget:**
```dart
class _StatItem extends StatelessWidget {
  final IconData icon;
  final String value;
  final String label;
  final bool highlight;
  
  const _StatItem({...});
  
  @override
  Widget build(BuildContext context) {
    return Expanded(
      child: Column(
        children: [
          Icon(icon, size: 24),
          const SizedBox(height: 4),
          Text(
            value,
            style: Theme.of(context).textTheme.headlineSmall?.copyWith(
              fontWeight: FontWeight.bold,
              color: highlight ? theme.colorScheme.primary : null,
            ),
          ),
          Text(
            label,
            style: Theme.of(context).textTheme.bodySmall,
          ),
        ],
      ),
    );
  }
}
```
  </action>
  <verify>Stats display and update correctly</verify>
  <done>Usage statistics section with grid layout</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] User email displays in Account section
- [ ] Join date shows for logged-in users
- [ ] Subscription status shows Free/Pro correctly
- [ ] Pro badge displays for Pro users
- [ ] Manage Subscription button works
- [ ] Usage stats show projects, exports, layers counts
- [ ] Credits remaining highlighted
- [ ] Last export time shows if available
- [ ] All sections follow design system
</verification>

<success_criteria>
- Account section with email and join date
- Subscription section with status and management
- Usage stats grid with projects/exports/layers
- Credits remaining prominently displayed
- Manage subscription deep-link works
- Consistent with design system
</success_criteria>

<output>
After completion, create `.planning/phases/21-settings-enhancement/21-02-SUMMARY.md`
</output>
