---
phase: 21-settings-enhancement
plan: 01
type: execute
depends_on: ["20-05"]
files_modified: [
  "lib/providers/stats_provider.dart"
]
autonomous: true
domain: flutter
---

<objective>
Create StatsProvider for aggregating user statistics to display in settings.

Purpose: Provide real-time access to user export stats, credit usage, and project counts for the enhanced settings screen.
Output: StatsProvider with Riverpod that aggregates data from Supabase.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/providers/credits_provider.dart
@lib/services/supabase_service.dart

**Requirements from ROADMAP:**
- SET-03: Settings displays export statistics (total exports, credits remaining)
- SET-04: Settings displays project count and storage usage

**Key decisions from STATE.md:**
- Riverpod provider dependencies must be declared when using ProviderScope overrides
- Use existing SupabaseService pattern for database queries

**Existing patterns (from credits_provider.dart):**
- StateNotifier with AsyncValue states
- Realtime subscription pattern via Supabase
- User-scoped queries with auth.uid() filtering
</context>

<tasks>

<task type="auto">
  <name>Create StatsProvider</name>
  <files>lib/providers/stats_provider.dart</files>
  <action>
Create StatsProvider following the CreditsProvider pattern:

**Data model:**
```dart
class UserStats {
  final int totalProjects;
  final int totalExports;
  final int totalLayers;
  final int creditsRemaining;
  final DateTime? lastExportAt;
  final DateTime? joinedAt;
  
  const UserStats({
    required this.totalProjects,
    required this.totalExports,
    required this.totalLayers,
    required this.creditsRemaining,
    this.lastExportAt,
    this.joinedAt,
  });
}
```

**Provider implementation:**
```dart
final statsProvider = StateNotifierProvider<StatsNotifier, AsyncValue<UserStats>>((ref) {
  return StatsNotifier(ref);
});

class StatsNotifier extends StateNotifier<AsyncValue<UserStats>> {
  final Ref _ref;
  StreamSubscription? _subscription;
  
  StatsNotifier(this._ref) : super(const AsyncValue.loading()) {
    _loadStats();
    _setupRealtimeSubscription();
  }
  
  Future<void> _loadStats() async {
    // Aggregate from:
    // - projects table (count)
    // - exports table (count, last_export_at)
    // - layers table (count via projects)
    // - user_credits table (credits_remaining)
    // - auth.users (joined_at)
  }
}
```

**Queries needed:**
1. Project count: `SELECT COUNT(*) FROM projects WHERE user_id = auth.uid()`
2. Export count: `SELECT COUNT(*) FROM exports WHERE user_id = auth.uid()`
3. Last export: `SELECT created_at FROM exports WHERE user_id = auth.uid() ORDER BY created_at DESC LIMIT 1`
4. Layer count: `SELECT COUNT(*) FROM layers WHERE project_id IN (SELECT id FROM projects WHERE user_id = auth.uid())`
5. Credits: Read from existing CreditsProvider (don't duplicate)

**Realtime subscriptions:**
- Subscribe to projects table changes for current user
- Subscribe to exports table changes for current user
- Subscribe to layers table changes (via project_ids)
- When any change detected, refresh stats

**Performance considerations:**
- Debounce rapid updates (500ms)
- Cache results in memory
- Expose refresh() method for manual refresh
  </action>
  <verify>
    - StatsProvider loads without errors
    - Stats update when projects/exports change
    - Manual refresh works
  </verify>
  <done>StatsProvider aggregates user statistics from multiple tables</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] StatsProvider created with UserStats model
- [ ] Aggregates projects, exports, layers counts
- [ ] Realtime subscriptions update stats automatically
- [ ] Debouncing prevents excessive queries
- [ ] Manual refresh exposed via public method
- [ ] Handles null user (logged out) gracefully
</verification>

<success_criteria>
- UserStats model with all required fields
- StatsProvider using Riverpod StateNotifier
- Realtime subscription to projects, exports, layers
- Debounced updates (500ms)
- Manual refresh capability
- Graceful handling of logged-out state
</success_criteria>

<output>
After completion, create `.planning/phases/21-settings-enhancement/21-01-SUMMARY.md`
</output>
