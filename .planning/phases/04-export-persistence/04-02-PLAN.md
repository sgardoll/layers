# Plan 04-02: .layers Pack Format

## Goal
Create a custom `.layers` file format that preserves full project state for re-editing.

## Context
- ZIP and PNG exports are lossy (no metadata, no layer order, no transforms)
- `.layers` format = complete project state that can be re-imported
- Similar to .psd or .sketch but simpler

## Format Specification

### .layers File Structure (ZIP-based)
```
project.layers (ZIP archive)
├── manifest.json        # Project metadata, layer order, transforms
├── original.png         # Original input image (optional)
├── layers/
│   ├── 0.png           # Layer 0 (bottom)
│   ├── 1.png           # Layer 1
│   └── ...
└── thumbnail.png       # Preview thumbnail (256x256)
```

### manifest.json Schema
```json
{
  "version": 1,
  "name": "Project Name",
  "createdAt": "2026-01-23T10:00:00Z",
  "updatedAt": "2026-01-23T12:00:00Z",
  "originalImageHash": "sha256...",
  "layers": [
    {
      "id": "uuid",
      "name": "Layer 0",
      "filename": "layers/0.png",
      "zIndex": 0,
      "visible": true,
      "opacity": 1.0,
      "transform": {
        "offsetX": 0, "offsetY": 0,
        "scale": 1.0, "rotation": 0
      }
    }
  ]
}
```

## Tasks

### 1. LayersPack Model
Create `lib/models/layers_pack.dart`:
- `LayersPackManifest` (Freezed) - manifest.json structure
- `LayersPackLayer` - layer entry in manifest

### 2. Export .layers
Add to ExportService:
- `exportAsLayersPack(Project project)` → creates .layers file
- Downloads all layer PNGs
- Generates thumbnail
- Creates manifest.json
- Zips everything with .layers extension

### 3. Import .layers
Create `lib/services/import_service.dart`:
- `importLayersPack(File file)` → returns Project
- Validates manifest version
- Extracts and caches layer PNGs
- Reconstructs Project model

### 4. File Association (Future)
- Register .layers extension with OS (iOS/macOS/Android)
- Open .layers files directly in app

## Files to Create/Modify
- CREATE: `lib/models/layers_pack.dart`
- MODIFY: `lib/services/export_service.dart` (add exportAsLayersPack)
- CREATE: `lib/services/import_service.dart`
- MODIFY: `lib/widgets/export_bottom_sheet.dart` (add .layers option)

## Verification
- [ ] .layers export creates valid ZIP with correct structure
- [ ] manifest.json contains all layer metadata
- [ ] Import reconstructs project exactly
- [ ] Round-trip: export → import → export produces identical file
- [ ] Handles missing/corrupt files gracefully
