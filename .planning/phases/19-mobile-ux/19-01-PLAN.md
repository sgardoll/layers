---
phase: 19-mobile-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "lib/screens/layers_screen.dart",
  "lib/widgets/layer_list_panel.dart",
  "lib/widgets/responsive_layout.dart"
]
autonomous: false
---

<objective>
Fix the mobile portrait UX issue where the layer list panel blocks the 3D visualizer, and implement responsive layout patterns throughout the app.

Purpose: The current layout uses a fixed 280px right panel that obscures the 3D viewer on mobile portrait. This phase makes the app usable on all screen sizes while maintaining the premium feel established in Phase 18.

Output: Responsive LayersScreen that adapts to screen size — side panel on desktop/tablet, bottom sheet or drawer on mobile portrait. Updated layer list panel with proper theming.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
@~/.config/opencode/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-design-system/18-01-SUMMARY.md
@lib/screens/layers_screen.dart
@lib/widgets/layer_list_panel.dart
@lib/theme/app_theme.dart
@lib/theme/app_colors.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create responsive layout helper and update LayerListPanel</name>
  <files>lib/widgets/responsive_layout.dart, lib/widgets/layer_list_panel.dart</files>
  <action>
Create a responsive layout system and update the layer list panel:

1. **lib/widgets/responsive_layout.dart** - Create a responsive helper:
   - Define breakpoints: mobile (<600px), tablet (600-900px), desktop (>900px)
   - Create `ResponsiveLayout` widget that takes mobile, tablet, desktop builders
   - Create `isMobile`, `isTablet`, `isDesktop` helper functions using MediaQuery
   - Export everything for use across the app

2. **lib/widgets/layer_list_panel.dart** - Update to support theming and sizing:
   - Remove the hardcoded `const Color(0xFF16213e)` background — use Theme.of(context).colorScheme.surface instead
   - Keep the width parameter but make it optional with sensible defaults
   - Update text colors to use Theme.of(context).colorScheme.onSurface and onSurfaceVariant
   - Ensure the panel works in both side-panel and bottom-sheet contexts
   - Keep all existing functionality (reorderable list, layer selection, etc.)

The panel should look good in both dark and light themes now that the design system is in place.
  </action>
  <verify>
    - `flutter analyze` passes with no errors
    - ResponsiveLayout widget can be instantiated
    - LayerListPanel compiles with theme-aware colors
  </verify>
  <done>
    lib/widgets/responsive_layout.dart exists with breakpoint helpers
    LayerListPanel uses Theme colors instead of hardcoded values
    Panel works with both light and dark themes
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor LayersScreen with responsive layout</name>
  <files>lib/screens/layers_screen.dart</files>
  <action>
Refactor LayersScreen to use responsive layout patterns:

**Current problem:** The Row with Expanded + fixed 280px panel doesn't work on mobile portrait.

**Solution:** Use LayoutBuilder or the ResponsiveLayout helper to adapt:

1. **Desktop/Tablet (width >= 600px):** Keep side-by-side layout
   - Expanded viewer on left (flex: 3)
   - LayerListPanel on right (280px width)
   - This is the current behavior, preserved for larger screens

2. **Mobile Portrait (width < 600px):** Use bottom sheet or drawer
   - Full-width 3D viewer takes entire screen
   - Layer list accessible via:
     - Floating action button that opens a modal bottom sheet, OR
     - A "Layers" button in the AppBar that opens an end drawer
   - Choose the approach that feels most natural — bottom sheet is probably better for quick access

3. **Implementation approach:**
   - Use LayoutBuilder to get constraints
   - If maxWidth >= 600: use the current Row layout
   - If maxWidth < 600: use Stack with full-screen viewer + FAB to open bottom sheet
   - The bottom sheet should show the LayerListPanel at 60-70% screen height

4. **Keep existing functionality:**
   - View mode toggle (3D/2D) should still work
   - Export FAB should still appear when layers exist
   - Loading and empty states should still work
   - All providers and state management unchanged

Import the responsive_layout.dart helpers and use them.
  </action>
  <verify>
    - `flutter analyze` passes
    - `flutter build` succeeds
    - LayersScreen compiles with responsive logic
  </verify>
  <done>
    LayersScreen uses LayoutBuilder for responsive detection
    Desktop/tablet (>=600px) shows side-by-side layout
    Mobile portrait (<600px) shows full-screen viewer with FAB for layers
    Bottom sheet opens with LayerListPanel at 60-70% height
    All existing functionality preserved
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Responsive LayersScreen that adapts to mobile portrait and desktop layouts</what-built>
  <how-to-verify>
    1. Run: `flutter run` (iOS simulator or Android emulator)
    2. Create a project and open it to see the LayersScreen
    3. Test Desktop/Tablet layout:
       - Use iPad simulator or resize to landscape
       - Verify: Side panel visible on right, 3D viewer on left
       - Verify: Layer list shows, can reorder layers
    4. Test Mobile Portrait layout:
       - Use iPhone simulator in portrait orientation
       - Verify: Full-screen 3D viewer (no side panel blocking)
       - Verify: FAB or button to open layers
       - Tap layers button: Bottom sheet opens with layer list
       - Verify: Can select and reorder layers in bottom sheet
    5. Test theme switching:
       - Switch between light/dark mode in system settings
       - Verify: Layer panel colors adapt to theme
    6. Test both view modes:
       - Verify 3D Space View works in both layouts
       - Verify 2D Stack View works in both layouts
  </how-to-verify>
  <resume-signal>Type "approved" if the responsive layout works correctly on both mobile and desktop, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `flutter analyze` passes with no errors
- [ ] `flutter build` succeeds for target platform
- [ ] ResponsiveLayout helper is reusable for other screens
- [ ] LayerListPanel uses theme colors (not hardcoded)
- [ ] Mobile portrait shows full-screen viewer (no blocking panel)
- [ ] Desktop/tablet shows side-by-side layout
- [ ] User has verified the responsive behavior works
</verification>

<success_criteria>
- Responsive layout system created (breakpoints, helpers)
- LayersScreen adapts to screen size (side panel vs bottom sheet)
- Mobile portrait: Full 3D viewer visible, layers in bottom sheet
- Desktop/tablet: Side-by-side layout preserved
- LayerListPanel themed correctly (uses AppColors)
- App works on all screen sizes from iPhone SE to iPad Pro
- User verified the fix resolves the blocking panel issue
</success_criteria>

<output>
After completion, create `.planning/phases/19-mobile-ux/19-01-SUMMARY.md`

Include:
- Responsive layout approach and breakpoints
- How the mobile UX issue was solved
- Files modified
- Testing notes
</output>
