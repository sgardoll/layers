# Fix Plan: Quick Task 004 - 3D Layer Viewer Issues

**Issues Found:** 4 major UAT issues in layer_space_view.dart
**Source:** 004-ISSUES.md
**Created:** 2026-02-04

## Issues to Fix

### FIX-001: Correct z-order calculation (UAT-001)
**File:** lib/widgets/layer_space_view.dart
**Problem:** Matrix4 translate z-values inverted - foreground layers appear behind background
**Solution:** Invert the z-translation sign in the Matrix4 transformation
- Current: `(sortedLayers[i].zIndex - sortedLayers.length / 2) * -camera.layerSpacing`
- Fix: `(sortedLayers[i].zIndex - sortedLayers.length / 2) * camera.layerSpacing` (remove the negative)

### FIX-002: Camera rotation gesture handling (UAT-002)
**File:** lib/widgets/layer_space_view.dart
**Problem:** Uncontrolled spinning when rotating - rotation delta calculation likely wrong
**Solution:** 
- Check `onScaleUpdate` rotation delta handling
- May need to reduce rotation sensitivity or add damping
- Verify rotationX/rotationY updates aren't accumulating incorrectly

### FIX-003: Filter hidden layers (UAT-003)
**File:** lib/widgets/layer_space_view.dart
**Problem:** Hidden layers still render with shadow
**Solution:**
- Add filter to exclude hidden layers from the 3D view
- Check layer.visible or layer.isHidden property
- Skip rendering if layer should be hidden

### FIX-004: Fix gesture hit testing (UAT-004)
**File:** lib/widgets/layer_space_view.dart
**Problem:** Tap selection only works on right side
**Solution:**
- LayerCard3D may have gesture detection issues after Transform change
- Check if Transform widget needs `transformHitTests: true`
- Verify gesture detection bounds align with visible layer area

## Implementation Order

1. FIX-003 (Filter hidden layers) - easiest, immediate visual improvement
2. FIX-001 (Z-order fix) - core functionality
3. FIX-004 (Hit testing) - interaction fix
4. FIX-002 (Rotation) - polish

## Verification

After each fix:
- Run `flutter analyze` to ensure no new errors
- Build and test 3D viewer
- Verify specific issue is resolved

## Success Criteria

- [ ] All 4 UAT issues resolved
- [ ] 3D viewer compiles without errors
- [ ] Layers appear in correct z-order
- [ ] Camera controls work smoothly
- [ ] Hidden layers don't appear
- [ ] All layers selectable via tap
