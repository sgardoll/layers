name: Build macOS PKG

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.1.3)'
        required: true
        type: string
      build_number:
        description: 'Build number (e.g., 16)'
        required: true
        type: string

concurrency:
  group: macos-build
  cancel-in-progress: false

jobs:
  build_macos:
    runs-on: macos-14
    timeout-minutes: 45
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.x'
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Setup CocoaPods
        run: |
          cd macos
          pod install --repo-update
          
      - name: Setup signing
        env:
          MAC_CERTIFICATE_BASE64: ${{ secrets.MAC_CERTIFICATE_BASE64 }}
          MAC_CERTIFICATE_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
          MAC_PROVISIONING_PROFILE_BASE64: ${{ secrets.MAC_PROVISIONING_PROFILE_BASE64 }}
          MAC_KEYCHAIN_PASSWORD: ${{ secrets.MAC_KEYCHAIN_PASSWORD }}
        run: |
          # Create keychain
          security create-keychain -p "$MAC_KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$MAC_KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate
          echo "$MAC_CERTIFICATE_BASE64" | base64 -d > certificate.p12
          security import certificate.p12 -k build.keychain -P "$MAC_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productbuild -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple:,codesign:,productbuild: -s -k "$MAC_KEYCHAIN_PASSWORD" build.keychain
          
          # Install provisioning profile
          echo "$MAC_PROVISIONING_PROFILE_BASE64" | base64 -d > profile.provisionprofile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.provisionprofile ~/Library/MobileDevice/Provisioning\ Profiles/
          
      - name: Build macOS app
        run: |
          flutter build macos \
            --release \
            --build-name=${{ github.event.inputs.version }} \
            --build-number=${{ github.event.inputs.build_number }}
            
      - name: Create PKG installer
        run: |
          APP_NAME="Layers"
          BUILD_DIR="build/macos/Build/Products/Release"
          APP_PATH="$BUILD_DIR/$APP_NAME.app"
          PKG_PATH="build/macos/$APP_NAME-${{ github.event.inputs.version }}+${{ github.event.inputs.build_number }}.pkg"
          
          # Sign the app bundle
          codesign --force --deep --sign "Developer ID Application" \
            --entitlements macos/Runner/Release.entitlements \
            "$APP_PATH"
          
          # Create PKG installer
          productbuild \
            --component "$APP_PATH" /Applications \
            --sign "Developer ID Installer" \
            --product macos/Runner/Info.plist \
            "$PKG_PATH"
          
          echo "Created PKG: $PKG_PATH"
          
      - name: Upload PKG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-pkg-${{ github.event.inputs.version }}+${{ github.event.inputs.build_number }}
          path: build/macos/Layers-*.pkg
          retention-days: 30
          
      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Successfully built Layers ${{ github.event.inputs.version }} (${{ github.event.inputs.build_number }}) macOS PKG"
